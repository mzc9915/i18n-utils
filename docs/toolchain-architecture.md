# i18n å·¥å…·é“¾æ¶æ„è®¾è®¡

## ä¸€ã€æ•´ä½“æ¶æ„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         i18n å·¥å…·é“¾                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚ i18n-extract â”‚â”€â”€>â”‚ i18n-review  â”‚â”€â”€>â”‚  i18n-apply  â”‚       â”‚
â”‚  â”‚  ä»£ç æå–    â”‚   â”‚   äººå·¥å®¡æ ¸    â”‚   â”‚  ä»£ç æ›¿æ¢    â”‚       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚         â”‚                                      â”‚                â”‚
â”‚         v                                      v                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”       â”‚
â”‚  â”‚pending-trans â”‚                      â”‚ æ›¿æ¢åçš„ä»£ç   â”‚       â”‚
â”‚  â”‚   å¾…ç¿»è¯‘æ¸…å•  â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜       â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                                              â”‚
â”‚         â”‚                                                       â”‚
â”‚         v                                                       â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚  â”‚   ç¿»è¯‘æœåŠ¡    â”‚â”€â”€>â”‚ i18n-import  â”‚                          â”‚
â”‚  â”‚ (äººå·¥/API)   â”‚   â”‚  å¯¼å…¥ç¿»è¯‘    â”‚                          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                              â”‚                                  â”‚
â”‚                              v                                  â”‚
â”‚                      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”                          â”‚
â”‚                      â”‚locales/*.ts  â”‚                          â”‚
â”‚                      â”‚ ç¿»è¯‘æ–‡ä»¶     â”‚                          â”‚
â”‚                      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                          â”‚
â”‚                              â”‚                                  â”‚
â”‚         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”‚
â”‚         v                    v                    v            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚  â”‚ i18n-check   â”‚   â”‚  i18n-sync   â”‚   â”‚ i18n-build   â”‚      â”‚
â”‚  â”‚  ä¸€è‡´æ€§æ£€æŸ¥   â”‚   â”‚  åŒæ­¥ key    â”‚   â”‚  æ„å»ºåˆå¹¶    â”‚      â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                  â”‚              â”‚
â”‚                                                  v              â”‚
â”‚                                          â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”‚
â”‚                                          â”‚dist/locales/ â”‚      â”‚
â”‚                                          â”‚  æŒ‰è¯­è¨€åˆ†ç»„   â”‚      â”‚
â”‚                                          â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜      â”‚
â”‚                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## äºŒã€å·¥å…·è¯¦ç»†è®¾è®¡

### 2.1 i18n-extract (æå–å·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. æ‰«ææºä»£ç ,æå–å¾…ç¿»è¯‘æ–‡æœ¬
2. åˆ†æä¸Šä¸‹æ–‡,ç”Ÿæˆè¯­ä¹‰åŒ– key
3. åˆ†ç±»è¾“å‡º (è‡ªåŠ¨/å®¡æ ¸/æ‰‹åŠ¨)
4. ç”Ÿæˆå¾…ç¿»è¯‘æ¸…å•

#### è¾“å…¥:
- æºä»£ç æ–‡ä»¶ (`src/**/*.{ts,tsx,js,jsx,vue}`)
- é…ç½®æ–‡ä»¶ (`i18n.config.ts`)

#### è¾“å‡º:
- `extract-manifest.json`: æå–æ¸…å• (åŒ…å«æ‰€æœ‰æå–é¡¹çš„è¯¦ç»†ä¿¡æ¯)
- `pending-translations.json`: å¾…ç¿»è¯‘æ–‡ä»¶ (æºè¯­è¨€ + TODO ç›®æ ‡è¯­è¨€)
- `review-report.md`: å®¡æ ¸æŠ¥å‘Š (éœ€è¦äººå·¥å¤„ç†çš„é¡¹ç›®)
- `auto-items.json`: å¯è‡ªåŠ¨å¤„ç†çš„é¡¹ç›®åˆ—è¡¨

#### å·¥ä½œæµç¨‹:

```typescript
class I18nExtractor {
  async extract() {
    // 1. æ‰«ææ–‡ä»¶
    const files = await this.scanFiles();
    
    // 2. å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œ AST è§£æ
    const allExtracted: ExtractedText[] = [];
    for (const file of files) {
      const extracted = await this.parseFile(file);
      allExtracted.push(...extracted);
    }
    
    // 3. ä¸Šä¸‹æ–‡åˆ†æå’Œ key ç”Ÿæˆ
    const analyzed = await this.analyzeAndGenerateKeys(allExtracted);
    
    // 4. åˆ†ç±»
    const classified = this.classify(analyzed);
    
    // 5. è¾“å‡ºç»“æœ
    await this.outputResults(classified);
    
    // 6. ç”ŸæˆæŠ¥å‘Š
    await this.generateReport(classified);
  }
  
  private classify(items: AnalyzedItem[]): ClassifiedResult {
    return {
      auto: items.filter(item => 
        item.complexity.score < 5 && 
        !item.markers?.manual
      ),
      review: items.filter(item => 
        item.complexity.score >= 5 && 
        !item.markers?.manual
      ),
      manual: items.filter(item => 
        item.markers?.manual
      ),
      ignored: items.filter(item => 
        item.markers?.ignore
      ),
    };
  }
}
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# åŸºç¡€ç”¨æ³•
npm run i18n:extract

# æŒ‡å®šé…ç½®æ–‡ä»¶
npm run i18n:extract -- --config=./custom-i18n.config.ts

# åªæ‰«æç‰¹å®šç›®å½•
npm run i18n:extract -- --include="src/pages/user/**"

# æŸ¥çœ‹è¯¦ç»†æ—¥å¿—
npm run i18n:extract -- --verbose

# è¾“å‡ºåˆ°æŒ‡å®šç›®å½•
npm run i18n:extract -- --output=./i18n-extract-result/
```

---

### 2.2 i18n-review (å®¡æ ¸å·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. äº¤äº’å¼å®¡æ ¸éœ€è¦äººå·¥ç¡®è®¤çš„é¡¹ç›®
2. è°ƒæ•´ key å‘½å
3. è°ƒæ•´æ¨¡å—å½’å±
4. æ ‡è®°å¤„ç†æ–¹å¼ (è‡ªåŠ¨/æ‰‹åŠ¨/å¿½ç•¥)

#### è¾“å…¥:
- `extract-manifest.json` (æå–æ¸…å•)

#### è¾“å‡º:
- `reviewed-manifest.json` (å®¡æ ¸åçš„æ¸…å•)
- æ›´æ–° `auto-items.json` å’Œ `manual-items.json`

#### äº¤äº’ç•Œé¢ (CLI):

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ i18n Review Tool - å®¡æ ¸è¿›åº¦: 3/23                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                          â”‚
â”‚ ğŸ“„ æ–‡ä»¶: src/pages/drama/detail.tsx:120                 â”‚
â”‚ ğŸ“ æ–‡æœ¬: "æ¬¢è¿ä½¿ç”¨æˆ‘ä»¬çš„äº§å“ç®¡ç†ç³»ç»Ÿ,è¿™é‡Œæä¾›..."       â”‚
â”‚                                                          â”‚
â”‚ ğŸ·ï¸  å»ºè®® Key: text_a7f9e2c1                            â”‚
â”‚ ğŸ“¦ å»ºè®®æ¨¡å—: drama.detail                               â”‚
â”‚                                                          â”‚
â”‚ âš ï¸  å¤æ‚åº¦: 7/10                                        â”‚
â”‚    åŸå› : é•¿æ–‡æœ¬ (125 å­—ç¬¦), åŒ…å«å¤šä¸ªå¥å­                â”‚
â”‚                                                          â”‚
â”‚ ğŸ” ä¸Šä¸‹æ–‡:                                              â”‚
â”‚    const introduction = `æ¬¢è¿ä½¿ç”¨...`                   â”‚
â”‚                                                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ æ“ä½œ:                                                    â”‚
â”‚   [1] æ¥å—å»ºè®® key                                       â”‚
â”‚   [2] è‡ªå®šä¹‰ key   â†’ introduction                       â”‚
â”‚   [3] è‡ªå®šä¹‰æ¨¡å—   â†’ drama.detail                       â”‚
â”‚   [4] æ ‡è®°ä¸ºæ‰‹åŠ¨å¤„ç†                                     â”‚
â”‚   [5] å¿½ç•¥æ­¤é¡¹                                          â”‚
â”‚   [s] è·³è¿‡                                              â”‚
â”‚   [q] é€€å‡ºå®¡æ ¸                                          â”‚
â”‚                                                          â”‚
â”‚ è¯·è¾“å…¥é€‰é¡¹ (1-5/s/q): _                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# äº¤äº’å¼å®¡æ ¸
npm run i18n:review

# å¿«é€Ÿæ¨¡å¼ (è‡ªåŠ¨æ¥å—æ‰€æœ‰å»ºè®®)
npm run i18n:review -- --accept-all

# åªå®¡æ ¸ç‰¹å®šæ¨¡å—
npm run i18n:review -- --module=drama

# æ‰¹é‡æ“ä½œ (é€šè¿‡é…ç½®æ–‡ä»¶)
npm run i18n:review -- --batch=./review-config.json
```

---

### 2.3 i18n-apply (ä»£ç æ›¿æ¢å·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. å°†æå–çš„ä¸­æ–‡æ›¿æ¢ä¸º `t()` è°ƒç”¨
2. ä¿æŒä»£ç æ ¼å¼å’Œç»“æ„
3. ç”Ÿæˆ diff å’Œå¤‡ä»½
4. æ”¯æŒæ’¤é”€

#### è¾“å…¥:
- `auto-items.json` (å¯è‡ªåŠ¨å¤„ç†çš„é¡¹ç›®)
- `reviewed-manifest.json` (å®¡æ ¸åçš„æ¸…å•)
- æºä»£ç æ–‡ä»¶

#### è¾“å‡º:
- æ›´æ–°åçš„æºä»£ç æ–‡ä»¶
- `apply-diff.patch` (å˜æ›´ diff)
- `backup/` (åŸæ–‡ä»¶å¤‡ä»½)

#### æ›¿æ¢ç­–ç•¥:

```typescript
class I18nApplier {
  async apply(mode: 'auto' | 'all' = 'auto') {
    // 1. åŠ è½½å¾…å¤„ç†é¡¹ç›®
    const items = mode === 'auto' 
      ? await this.loadAutoItems()
      : await this.loadAllItems();
    
    // 2. æŒ‰æ–‡ä»¶åˆ†ç»„
    const itemsByFile = this.groupByFile(items);
    
    // 3. å¯¹æ¯ä¸ªæ–‡ä»¶è¿›è¡Œæ›¿æ¢
    for (const [filePath, fileItems] of Object.entries(itemsByFile)) {
      // å¤‡ä»½åŸæ–‡ä»¶
      await this.backup(filePath);
      
      // AST æ›¿æ¢
      const result = await this.replaceInFile(filePath, fileItems);
      
      // ç”Ÿæˆ diff
      await this.generateDiff(filePath, result);
      
      // å†™å…¥æ–‡ä»¶
      await this.writeFile(filePath, result.code);
    }
  }
  
  private async replaceInFile(
    filePath: string, 
    items: ApplyItem[]
  ): Promise<ReplaceResult> {
    const code = await fs.readFile(filePath, 'utf-8');
    const ast = parse(code);
    
    // æŒ‰è¡Œå·æ’åº (ä»åå¾€å‰æ›¿æ¢,é¿å…ä½ç½®åç§»)
    const sortedItems = items.sort((a, b) => b.line - a.line);
    
    traverse(ast, {
      // æ ¹æ® nodeType ä½¿ç”¨å¯¹åº”çš„ visitor
      StringLiteral(path) {
        const item = this.findMatchingItem(path, sortedItems);
        if (item) {
          const replacement = this.generateReplacement(item);
          path.replaceWith(replacement);
        }
      },
      JSXText(path) {
        // åŒä¸Š...
      },
    });
    
    const newCode = generate(ast);
    return { code: newCode, ast };
  }
  
  private generateReplacement(item: ApplyItem): Node {
    const fullKey = `${item.module}.${item.key}`;
    
    // æ ¹æ®ä¸Šä¸‹æ–‡ç”Ÿæˆä¸åŒçš„æ›¿æ¢ä»£ç 
    if (item.nodeType === 'JSXText') {
      // <div>æ–‡æœ¬</div> â†’ <div>{t('key')}</div>
      return types.jSXExpressionContainer(
        types.callExpression(
          types.identifier('t'),
          [types.stringLiteral(fullKey)]
        )
      );
    } else if (item.parentType === 'JSXAttribute') {
      // <input placeholder="æ–‡æœ¬" />
      // â†’ <input placeholder={t('key')} />
      return types.jSXExpressionContainer(
        types.callExpression(
          types.identifier('t'),
          [types.stringLiteral(fullKey)]
        )
      );
    } else {
      // const x = "æ–‡æœ¬" â†’ const x = t('key')
      return types.callExpression(
        types.identifier('t'),
        [types.stringLiteral(fullKey)]
      );
    }
  }
}
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# åªåº”ç”¨è‡ªåŠ¨å¤„ç†é¡¹
npm run i18n:apply

# åº”ç”¨æ‰€æœ‰é¡¹ (åŒ…æ‹¬å®¡æ ¸åçš„)
npm run i18n:apply -- --mode=all

# é¢„è§ˆå˜æ›´ (ä¸å®é™…ä¿®æ”¹æ–‡ä»¶)
npm run i18n:apply -- --dry-run

# åªå¤„ç†ç‰¹å®šæ–‡ä»¶
npm run i18n:apply -- --file="src/pages/user/login.tsx"

# æ’¤é”€æ›¿æ¢
npm run i18n:apply -- --undo
```

---

### 2.4 i18n-sync (åŒæ­¥å·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. ä»¥æºè¯­è¨€ (å¦‚ä¸­æ–‡) ä¸ºåŸºå‡†
2. åŒæ­¥å…¶ä»–è¯­è¨€çš„ key ç»“æ„
3. è‡ªåŠ¨æ·»åŠ ç¼ºå¤±çš„ key (æ ‡è®° TODO)
4. ç§»é™¤åºŸå¼ƒçš„ key

#### è¾“å…¥:
- `src/locales/**/*.ts` (æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶)

#### è¾“å‡º:
- æ›´æ–°åçš„ç¿»è¯‘æ–‡ä»¶
- `sync-report.json` (åŒæ­¥æŠ¥å‘Š)

#### åŒæ­¥é€»è¾‘:

```typescript
class I18nSyncer {
  async sync() {
    // 1. åŠ è½½æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶
    const files = await this.loadAllTranslationFiles();
    
    // 2. æå–æ‰€æœ‰ key å’Œè¯­è¨€
    const { keys, languages } = this.extractKeysAndLanguages(files);
    
    // 3. æ£€æµ‹é—®é¢˜
    const issues = this.detectIssues(keys, languages);
    
    // 4. è‡ªåŠ¨ä¿®å¤
    const fixed = await this.autoFix(issues);
    
    // 5. ç”ŸæˆæŠ¥å‘Š
    await this.generateReport(issues, fixed);
  }
  
  private detectIssues(
    keys: Set<string>, 
    languages: string[]
  ): SyncIssue[] {
    const issues: SyncIssue[] = [];
    
    for (const file of this.translationFiles) {
      const content = file.content;
      
      // æ£€æŸ¥æ¯ä¸ª key
      for (const [key, translations] of Object.entries(content)) {
        // é—®é¢˜1: æŸäº›è¯­è¨€ç¼ºå¤±
        const missingLangs = languages.filter(
          lang => !translations[lang]
        );
        if (missingLangs.length > 0) {
          issues.push({
            type: 'MISSING_TRANSLATION',
            file: file.path,
            key,
            missingLangs,
          });
        }
        
        // é—®é¢˜2: ç¿»è¯‘ä¸ºç©º
        const emptyLangs = languages.filter(
          lang => translations[lang] === '' || 
                  translations[lang] === 'TODO'
        );
        if (emptyLangs.length > 0) {
          issues.push({
            type: 'EMPTY_TRANSLATION',
            file: file.path,
            key,
            emptyLangs,
          });
        }
        
        // é—®é¢˜3: å¤šä½™çš„è¯­è¨€
        const extraLangs = Object.keys(translations).filter(
          lang => !languages.includes(lang)
        );
        if (extraLangs.length > 0) {
          issues.push({
            type: 'EXTRA_LANGUAGE',
            file: file.path,
            key,
            extraLangs,
          });
        }
      }
    }
    
    return issues;
  }
  
  private async autoFix(issues: SyncIssue[]): Promise<FixResult[]> {
    const results: FixResult[] = [];
    
    for (const issue of issues) {
      if (issue.type === 'MISSING_TRANSLATION') {
        // æ·»åŠ ç¼ºå¤±çš„è¯­è¨€,æ ‡è®°ä¸º TODO
        for (const lang of issue.missingLangs) {
          await this.addTranslation(
            issue.file, 
            issue.key, 
            lang, 
            'TODO'
          );
        }
        results.push({ issue, action: 'ADDED_TODO' });
      }
      
      if (issue.type === 'EXTRA_LANGUAGE') {
        // ç§»é™¤å¤šä½™çš„è¯­è¨€
        for (const lang of issue.extraLangs) {
          await this.removeTranslation(issue.file, issue.key, lang);
        }
        results.push({ issue, action: 'REMOVED' });
      }
    }
    
    return results;
  }
}
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# æ£€æŸ¥å¹¶åŒæ­¥
npm run i18n:sync

# åªæ£€æŸ¥ä¸ä¿®å¤
npm run i18n:sync -- --check-only

# è‡ªåŠ¨å¡«å…… TODO
npm run i18n:sync -- --fill-todo

# ç§»é™¤åºŸå¼ƒ key
npm run i18n:sync -- --remove-unused
```

---

### 2.5 i18n-check (ä¸€è‡´æ€§æ£€æŸ¥å·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. æ£€æŸ¥æ‰€æœ‰ key åœ¨æ‰€æœ‰è¯­è¨€ä¸­æ˜¯å¦å­˜åœ¨
2. æ£€æµ‹ç¿»è¯‘å†…å®¹æ˜¯å¦ä¸ºç©ºæˆ– TODO
3. éªŒè¯æ’å€¼å˜é‡ä¸€è‡´æ€§
4. æ£€æµ‹é‡å¤ key
5. æ£€æŸ¥ä»£ç ä¸­å¼•ç”¨çš„ key æ˜¯å¦å­˜åœ¨

#### è¾“å…¥:
- `src/locales/**/*.ts` (ç¿»è¯‘æ–‡ä»¶)
- æºä»£ç æ–‡ä»¶ (æ£€æŸ¥ `t()` è°ƒç”¨)

#### è¾“å‡º:
- `check-report.json` (æ£€æŸ¥æŠ¥å‘Š)
- ç»ˆç«¯å½©è‰²è¾“å‡º
- CI é€€å‡ºç  (æœ‰é”™è¯¯åˆ™é 0)

#### æ£€æŸ¥é€»è¾‘:

```typescript
class I18nChecker {
  async check(): Promise<CheckResult> {
    const issues: Issue[] = [];
    
    // æ£€æŸ¥1: Key å®Œæ•´æ€§
    issues.push(...await this.checkKeyCompleteness());
    
    // æ£€æŸ¥2: ç¿»è¯‘å†…å®¹
    issues.push(...await this.checkTranslationContent());
    
    // æ£€æŸ¥3: æ’å€¼å˜é‡
    issues.push(...await this.checkInterpolationVars());
    
    // æ£€æŸ¥4: é‡å¤ key
    issues.push(...await this.checkDuplicateKeys());
    
    // æ£€æŸ¥5: ä»£ç å¼•ç”¨
    issues.push(...await this.checkCodeReferences());
    
    return {
      issues,
      hasErrors: issues.some(i => i.severity === 'error'),
      hasWarnings: issues.some(i => i.severity === 'warning'),
    };
  }
  
  private async checkKeyCompleteness(): Promise<Issue[]> {
    const issues: Issue[] = [];
    const allKeys = new Set<string>();
    const languages = this.config.targetLangList;
    
    // æ”¶é›†æ‰€æœ‰ key
    for (const file of this.translationFiles) {
      for (const key of Object.keys(file.content)) {
        allKeys.add(key);
      }
    }
    
    // æ£€æŸ¥æ¯ä¸ª key åœ¨æ‰€æœ‰è¯­è¨€ä¸­æ˜¯å¦å­˜åœ¨
    for (const key of allKeys) {
      for (const lang of languages) {
        const translation = this.getTranslation(key, lang);
        if (!translation) {
          issues.push({
            type: 'MISSING_KEY',
            severity: 'error',
            key,
            language: lang,
            message: `Key "${key}" ç¼ºå¤± ${lang} ç¿»è¯‘`,
          });
        }
      }
    }
    
    return issues;
  }
  
  private async checkInterpolationVars(): Promise<Issue[]> {
    const issues: Issue[] = [];
    
    for (const file of this.translationFiles) {
      for (const [key, translations] of Object.entries(file.content)) {
        // æå–æ‰€æœ‰è¯­è¨€çš„æ’å€¼å˜é‡
        const varsMap: Record<string, string[]> = {};
        for (const [lang, text] of Object.entries(translations)) {
          varsMap[lang] = this.extractInterpolationVars(text);
        }
        
        // æ£€æŸ¥å˜é‡æ˜¯å¦ä¸€è‡´
        const refLang = this.config.originLang;
        const refVars = varsMap[refLang] || [];
        
        for (const [lang, vars] of Object.entries(varsMap)) {
          if (lang === refLang) continue;
          
          const missing = refVars.filter(v => !vars.includes(v));
          const extra = vars.filter(v => !refVars.includes(v));
          
          if (missing.length > 0 || extra.length > 0) {
            issues.push({
              type: 'INTERPOLATION_MISMATCH',
              severity: 'error',
              key,
              language: lang,
              message: `æ’å€¼å˜é‡ä¸ä¸€è‡´`,
              details: { missing, extra, expected: refVars },
            });
          }
        }
      }
    }
    
    return issues;
  }
  
  private async checkCodeReferences(): Promise<Issue[]> {
    const issues: Issue[] = [];
    
    // 1. æ”¶é›†æ‰€æœ‰æœ‰æ•ˆçš„ key
    const validKeys = new Set<string>();
    for (const file of this.translationFiles) {
      const module = this.getModuleName(file.path);
      for (const key of Object.keys(file.content)) {
        validKeys.add(`${module}.${key}`);
      }
    }
    
    // 2. æ‰«æä»£ç ä¸­çš„ t() è°ƒç”¨
    const codeFiles = await this.scanCodeFiles();
    for (const file of codeFiles) {
      const usedKeys = this.extractUsedKeys(file);
      
      for (const usedKey of usedKeys) {
        if (!validKeys.has(usedKey.key)) {
          issues.push({
            type: 'INVALID_REFERENCE',
            severity: 'error',
            key: usedKey.key,
            file: file.path,
            line: usedKey.line,
            message: `å¼•ç”¨çš„ key "${usedKey.key}" ä¸å­˜åœ¨`,
          });
        }
      }
    }
    
    return issues;
  }
}
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# è¿è¡Œæ‰€æœ‰æ£€æŸ¥
npm run i18n:check

# åªæ£€æŸ¥ç‰¹å®šç±»å‹
npm run i18n:check -- --checks=completeness,interpolation

# ä»¥ JSON æ ¼å¼è¾“å‡º
npm run i18n:check -- --format=json > check-result.json

# CI æ¨¡å¼ (æœ‰é”™è¯¯æ—¶é€€å‡ºç é 0)
npm run i18n:check -- --ci
```

#### è¾“å‡ºç¤ºä¾‹:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ i18n Check Report                                        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ âœ… é€šè¿‡: 156 é¡¹                                         â”‚
â”‚ âŒ é”™è¯¯: 3 é¡¹                                           â”‚
â”‚ âš ï¸  è­¦å‘Š: 12 é¡¹                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

âŒ é”™è¯¯ (3):

  1. [MISSING_KEY] drama.list.title ç¼ºå¤± en-US ç¿»è¯‘
     ğŸ“„ src/locales/drama/list.ts
     
  2. [INTERPOLATION_MISMATCH] user.login.welcome æ’å€¼å˜é‡ä¸ä¸€è‡´
     ğŸ“„ src/locales/user/login.ts
     é¢„æœŸå˜é‡: [username]
     å®é™…å˜é‡: [userName]  (en-US)
     
  3. [INVALID_REFERENCE] å¼•ç”¨çš„ key "drama.player.controls" ä¸å­˜åœ¨
     ğŸ“„ src/pages/drama/player.tsx:45

âš ï¸  è­¦å‘Š (12):

  1. [EMPTY_TRANSLATION] common.buttons.submit ç¿»è¯‘ä¸ºç©º (ja-JP)
  2. [TODO_TRANSLATION] drama.detail.intro ç¿»è¯‘ä¸º TODO (ko-KR)
  ...
```

---

### 2.6 i18n-build (æ„å»ºå·¥å…·)

#### æ ¸å¿ƒèŒè´£:
1. æ‰«æ `src/locales/` ä¸‹æ‰€æœ‰ç¿»è¯‘æ–‡ä»¶
2. æŒ‰æ¨¡å—è·¯å¾„ç”Ÿæˆå®Œæ•´ key
3. æŒ‰è¯­è¨€é‡æ–°ç»„ç»‡æ•°æ®
4. è¾“å‡ºæŒ‰è¯­è¨€åˆ†ç»„çš„ JSON æ–‡ä»¶

#### è¾“å…¥:
- `src/locales/**/*.ts` (æ¨¡å—åŒ–ç¿»è¯‘æ–‡ä»¶)

#### è¾“å‡º:
- `dist/locales/zh-CN.json`
- `dist/locales/en-US.json`
- `dist/locales/ja-JP.json`
- ...

#### æ„å»ºé€»è¾‘:

```typescript
class I18nBuilder {
  async build() {
    // 1. æ‰«ææ‰€æœ‰ç¿»è¯‘æ–‡ä»¶
    const files = glob.sync('src/locales/**/*.ts');
    
    // 2. æå–ç¿»è¯‘å†…å®¹
    const translations = await this.extractTranslations(files);
    
    // 3. æŒ‰è¯­è¨€é‡ç»„
    const byLang = this.groupByLanguage(translations);
    
    // 4. æ‰å¹³åŒ– (å¯é€‰)
    const flattened = this.config.build.outputFormat === 'flat'
      ? this.flatten(byLang)
      : byLang;
    
    // 5. è¾“å‡ºæ–‡ä»¶
    for (const [lang, content] of Object.entries(flattened)) {
      await this.writeJSON(
        `${this.config.build.outputDir}/${lang}.json`,
        content
      );
    }
  }
  
  private async extractTranslations(
    files: string[]
  ): Promise<Translation[]> {
    const translations: Translation[] = [];
    
    for (const filePath of files) {
      // æ¨æ–­æ¨¡å—å: src/locales/drama/list.ts â†’ drama.list
      const module = this.inferModuleName(filePath);
      
      // åŠ¨æ€å¯¼å…¥ TypeScript æ–‡ä»¶
      const content = await import(filePath);
      const defaultExport = content.default;
      
      // éå†æ–‡ä»¶ä¸­çš„æ‰€æœ‰ key
      for (const [key, langMap] of Object.entries(defaultExport)) {
        translations.push({
          fullKey: `${module}.${key}`,
          translations: langMap as Record<string, string>,
        });
      }
    }
    
    return translations;
  }
  
  private groupByLanguage(
    translations: Translation[]
  ): Record<string, Record<string, string>> {
    const result: Record<string, Record<string, string>> = {};
    
    for (const item of translations) {
      for (const [lang, text] of Object.entries(item.translations)) {
        result[lang] = result[lang] || {};
        result[lang][item.fullKey] = text;
      }
    }
    
    return result;
  }
  
  private flatten(
    nested: Record<string, any>
  ): Record<string, string> {
    // å°†åµŒå¥—å¯¹è±¡è½¬ä¸ºæ‰å¹³åŒ–
    // { drama: { list: { title: "xxx" } } }
    // â†’ { "drama.list.title": "xxx" }
    const result: Record<string, string> = {};
    
    function recurse(obj: any, prefix = '') {
      for (const [key, value] of Object.entries(obj)) {
        const fullKey = prefix ? `${prefix}.${key}` : key;
        if (typeof value === 'object') {
          recurse(value, fullKey);
        } else {
          result[fullKey] = value;
        }
      }
    }
    
    recurse(nested);
    return result;
  }
}
```

#### å‘½ä»¤è¡Œæ¥å£:

```bash
# æ„å»ºæ‰€æœ‰è¯­è¨€
npm run i18n:build

# åªæ„å»ºç‰¹å®šè¯­è¨€
npm run i18n:build -- --lang=en-US,ja-JP

# è¾“å‡ºæ ¼å¼: åµŒå¥—
npm run i18n:build -- --format=nested

# è¾“å‡ºæ ¼å¼: æ‰å¹³
npm run i18n:build -- --format=flat

# è¾“å‡ºåˆ°æŒ‡å®šç›®å½•
npm run i18n:build -- --output=./public/locales/
```

#### è¾“å‡ºç¤ºä¾‹:

**æ‰å¹³åŒ–æ ¼å¼** (`zh-CN.json`):
```json
{
  "common.buttons.btn_submit": "æäº¤",
  "common.buttons.btn_cancel": "å–æ¶ˆ",
  "drama.list.title": "å‰§é›†åˆ—è¡¨",
  "drama.detail.btn_play": "æ’­æ”¾"
}
```

**åµŒå¥—æ ¼å¼** (`zh-CN.json`):
```json
{
  "common": {
    "buttons": {
      "btn_submit": "æäº¤",
      "btn_cancel": "å–æ¶ˆ"
    }
  },
  "drama": {
    "list": {
      "title": "å‰§é›†åˆ—è¡¨"
    },
    "detail": {
      "btn_play": "æ’­æ”¾"
    }
  }
}
```

---

## ä¸‰ã€å·¥å…·é›†æˆä¸å·¥ä½œæµ

### 3.1 å®Œæ•´å·¥ä½œæµ

```bash
# æ­¥éª¤ 1: æå–
npm run i18n:extract
# è¾“å‡º: extract-manifest.json, pending-translations.json, review-report.md

# æ­¥éª¤ 2: å®¡æ ¸ (å¯é€‰)
npm run i18n:review
# è¾“å‡º: reviewed-manifest.json

# æ­¥éª¤ 3: åº”ç”¨æ›¿æ¢
npm run i18n:apply
# è¾“å‡º: æ›´æ–°åçš„æºä»£ç , apply-diff.patch

# æ­¥éª¤ 4: å¯¼å…¥ç¿»è¯‘
# (äººå·¥ç¿»è¯‘æˆ– API ç¿»è¯‘)
npm run i18n:import -- --file=./translations.json

# æ­¥éª¤ 5: åŒæ­¥
npm run i18n:sync
# è¾“å‡º: sync-report.json

# æ­¥éª¤ 6: æ£€æŸ¥
npm run i18n:check
# è¾“å‡º: check-report.json

# æ­¥éª¤ 7: æ„å»º
npm run i18n:build
# è¾“å‡º: dist/locales/*.json
```

### 3.2 æ—¥å¸¸å¼€å‘æµç¨‹

```bash
# å¼€å‘æ–°åŠŸèƒ½
# 1. æ‰‹åŠ¨åœ¨ src/locales/ æ·»åŠ  key
# 2. åœ¨ä»£ç ä¸­ä½¿ç”¨ t('module.key')

# æäº¤å‰æ£€æŸ¥
npm run i18n:check

# å®šæœŸåŒæ­¥
npm run i18n:sync

# æ„å»º
npm run i18n:build
```

### 3.3 CI/CD é›†æˆ

```yaml
# .github/workflows/i18n-check.yml
name: i18n Check

on: [push, pull_request]

jobs:
  i18n-check:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      
      - name: Install dependencies
        run: npm install
      
      - name: Run i18n check
        run: npm run i18n:check -- --ci
      
      - name: Upload check report
        if: failure()
        uses: actions/upload-artifact@v2
        with:
          name: i18n-check-report
          path: check-report.json
```

---

## å››ã€æŠ€æœ¯é€‰å‹ä¸å®ç°å»ºè®®

### 4.1 æ¨èæŠ€æœ¯æ ˆ

| æ¨¡å— | æ¨èå·¥å…· | ç”¨é€” |
|-----|---------|------|
| AST è§£æ | @babel/parser, @babel/traverse | ä»£ç è§£æå’Œéå† |
| æ–‡ä»¶æ“ä½œ | fs-extra, glob | æ–‡ä»¶è¯»å†™å’ŒåŒ¹é… |
| CLI å·¥å…· | commander, inquirer, chalk, ora | å‘½ä»¤è¡Œäº¤äº’ |
| é…ç½®ç®¡ç† | cosmiconfig | é…ç½®æ–‡ä»¶åŠ è½½ |
| ä¸­æ–‡å¤„ç† | pinyin | ä¸­æ–‡è½¬æ‹¼éŸ³ |
| Hash ç”Ÿæˆ | crypto (Node.js å†…ç½®) | ç”Ÿæˆå”¯ä¸€æ ‡è¯† |
| Diff ç”Ÿæˆ | diff | ç”Ÿæˆä»£ç å·®å¼‚ |
| ç±»å‹æ”¯æŒ | TypeScript | ç±»å‹å®‰å…¨ |

### 4.2 é¡¹ç›®ç»“æ„

```
packages/
â”œâ”€â”€ i18n-extract/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ scanner/         # æ‰«æå™¨
â”‚   â”‚   â”œâ”€â”€ analyzer/        # åˆ†æå™¨
â”‚   â”‚   â”œâ”€â”€ generator/       # Key ç”Ÿæˆå™¨
â”‚   â”‚   â”œâ”€â”€ marker/          # æ ‡è®°è§£æå™¨
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ i18n-apply/
â”‚   â”œâ”€â”€ src/
â”‚   â”‚   â”œâ”€â”€ replacer/        # æ›¿æ¢é€»è¾‘
â”‚   â”‚   â”œâ”€â”€ backup/          # å¤‡ä»½ç®¡ç†
â”‚   â”‚   â””â”€â”€ index.ts
â”‚   â””â”€â”€ package.json
â”‚
â”œâ”€â”€ i18n-sync/
â”œâ”€â”€ i18n-check/
â”œâ”€â”€ i18n-build/
â”‚
â””â”€â”€ i18n-cli/               # ç»Ÿä¸€ CLI å…¥å£
    â”œâ”€â”€ src/
    â”‚   â””â”€â”€ index.ts
    â””â”€â”€ package.json
```

### 4.3 ä»£ç å¤ç”¨

å…±äº«æ ¸å¿ƒæ¨¡å—:
```
packages/
â””â”€â”€ i18n-core/              # å…±äº«æ ¸å¿ƒ
    â”œâ”€â”€ src/
    â”‚   â”œâ”€â”€ config/         # é…ç½®åŠ è½½
    â”‚   â”œâ”€â”€ utils/          # å·¥å…·å‡½æ•°
    â”‚   â”œâ”€â”€ types/          # ç±»å‹å®šä¹‰
    â”‚   â””â”€â”€ constants/      # å¸¸é‡
    â””â”€â”€ package.json
```

---

## äº”ã€å¼€å‘å»ºè®®

### 5.1 æ¸è¿›å¼å¼€å‘

**é˜¶æ®µ 1** (2 å‘¨): i18n-extract
- åŸºç¡€æ‰«æåŠŸèƒ½
- ç®€å•çš„ key ç”Ÿæˆ
- è¾“å‡º JSON æ¸…å•

**é˜¶æ®µ 2** (1 å‘¨): i18n-apply
- åŸºç¡€æ›¿æ¢åŠŸèƒ½
- æ”¯æŒå¤‡ä»½å’Œæ’¤é”€

**é˜¶æ®µ 3** (1 å‘¨): i18n-build
- æ„å»ºæ—¶åˆå¹¶
- è¾“å‡ºæŒ‰è¯­è¨€åˆ†ç»„

**é˜¶æ®µ 4** (1 å‘¨): i18n-check + i18n-sync
- ä¸€è‡´æ€§æ£€æŸ¥
- è‡ªåŠ¨åŒæ­¥

**é˜¶æ®µ 5** (1 å‘¨): å¢å¼ºå’Œä¼˜åŒ–
- äº¤äº’å¼å®¡æ ¸ (i18n-review)
- å¤æ‚åœºæ™¯æ”¯æŒ
- æ€§èƒ½ä¼˜åŒ–

### 5.2 å‚è€ƒå’Œå€Ÿé‰´

ä¸è¦ä»é›¶å¼€å§‹,å‚è€ƒç°æœ‰å·¥å…·:

1. **i18next-scanner**
   - GitHub: https://github.com/i18next/i18next-scanner
   - å€Ÿé‰´: æ‰«æé€»è¾‘ã€é…ç½®ç»“æ„

2. **kiwi (é˜¿é‡Œ)**
   - GitHub: https://github.com/alibaba/kiwi
   - å€Ÿé‰´: Key ç”Ÿæˆç­–ç•¥ã€VSCode æ’ä»¶

3. **react-intl-universal**
   - å€Ÿé‰´: è¿è¡Œæ—¶ API è®¾è®¡

4. **formatjs**
   - å€Ÿé‰´: æ’å€¼å’Œå¤æ•°å¤„ç†

### 5.3 ä¼˜å…ˆçº§å»ºè®®

**é«˜ä¼˜å…ˆçº§:**
- âœ… i18n-extract (æ ¸å¿ƒ,æœ€é‡è¦)
- âœ… i18n-apply (ä»£ç æ›¿æ¢)
- âœ… i18n-build (æ„å»ºåˆå¹¶)

**ä¸­ä¼˜å…ˆçº§:**
- âš ï¸ i18n-check (è´¨é‡ä¿è¯)
- âš ï¸ i18n-sync (ç»´æŠ¤ä¾¿åˆ©)

**ä½ä¼˜å…ˆçº§:**
- ğŸ’¡ i18n-review (äº¤äº’å¼å®¡æ ¸,å¯åç»­ä¼˜åŒ–)
- ğŸ’¡ VSCode æ’ä»¶ (æå‡ä½“éªŒ,å¯ v2.0)

---

## å…­ã€æ€»ç»“

è¿™å¥—å·¥å…·é“¾çš„æ ¸å¿ƒç†å¿µæ˜¯:

1. **è‡ªåŠ¨åŒ–ä¼˜å…ˆ**: èƒ½è‡ªåŠ¨å¤„ç†çš„åœºæ™¯,å°½é‡è‡ªåŠ¨åŒ–
2. **äººå·¥å®¡æ ¸è¡¥å……**: å¤æ‚åœºæ™¯,æä¾›å®¡æ ¸æœºåˆ¶
3. **çµæ´»å¯é…ç½®**: æ”¯æŒå¤šç§ç­–ç•¥å’Œè‡ªå®šä¹‰
4. **è´¨é‡ä¿è¯**: å¤šé‡æ£€æŸ¥,ç¡®ä¿ä¸€è‡´æ€§
5. **æ¸è¿›å¼å®æ–½**: ä¸è¦æ±‚ä¸€æ¬¡å®Œæˆæ‰€æœ‰åŠŸèƒ½

ä¸‹ä¸€æ­¥:
1. åŸºäº `ast-scene-analysis.md` å®Œå–„ AST è¯†åˆ«èƒ½åŠ›
2. å®ç° `i18n-extract` æ ¸å¿ƒåŠŸèƒ½
3. å¼€å‘ CLI å·¥å…·
4. ç¼–å†™æµ‹è¯•ç”¨ä¾‹
5. æ’°å†™ä½¿ç”¨æ–‡æ¡£

