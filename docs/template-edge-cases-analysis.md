# Template 边界场景分析

## 📊 当前实现的处理能力

### ✅ 能正确处理的场景

1. **完整的文本节点**
   ```vue
   <p>这是一个完整的段落文本，应该作为整体提取。</p>
   <!-- 提取: "这是一个完整的段落文本，应该作为整体提取。" ✅ -->
   ```

2. **按钮文本**
   ```vue
   <button>提交表单</button>
   <!-- 提取: "提交表单" ✅ -->
   ```

3. **列表项**
   ```vue
   <li>第一项</li>
   <li>第二项</li>
   <!-- 分别提取: "第一项", "第二项" ✅ -->
   ```

4. **表格单元格**
   ```vue
   <td>产品名称</td>
   <td>产品价格</td>
   <!-- 分别提取: "产品名称", "产品价格" ✅ -->
   ```

---

## ⚠️ 存在问题的场景

### 问题1: 分散的文本节点（上下文丢失）

**场景：**
```vue
<div>
  <span style="color: grey;">已选择</span>
  <span style="color: blue;">{{ count }}</span>
  <span style="color: grey;">项</span>
</div>
```

**当前提取结果：**
- ✅ "已选择"
- ✅ "项"

**问题：**
- ❌ 提取了 2 个孤立的文本，翻译时会失去上下文
- ❌ 应该提取: "已选择{count}项" 或标记为需要人工处理

---

### 问题2: 分散的纯文本（无法组合）

**场景：**
```vue
<div>
  <span style="color: grey;">总共</span>
  <span style="color: grey;">条记录</span>
</div>
```

**当前提取结果：**
- ✅ "总共"
- ✅ "条记录"

**问题：**
- ❌ 2 个片段独立翻译会导致语义错误
- ❌ 应该提取: "总共_条记录" 或 "总共{n}条记录"（需要判断中间是否有插值）

---

### 问题3: 混合文本和插值

**场景：**
```vue
<div>
  当前页：<span>{{ page }}</span> / 总页数：<span>{{ total }}</span>
</div>
```

**当前提取结果：**
- ✅ "当前页："

**问题：**
- ❌ 只提取了部分文本，丢失了 " / 总页数："
- ❌ 应该提取: "当前页：{page} / 总页数：{total}"

---

### 问题4: 嵌套结构中的标签文本

**场景：**
```vue
<div class="info">
  <span class="label">用户名：</span>
  <span class="value">{{ userName }}</span>
</div>
```

**当前提取结果：**
- ✅ "用户名："

**问题：**
- ⚠️ 这个场景提取是对的，但需要识别是 label 类型的文本
- ⚠️ 建议: 保存 parentClass 信息，标记为 "label" 类型

---

### 问题5: 带 HTML 标签的长文本

**场景：**
```vue
<div class="description">
  这是产品介绍的<strong>第一段</strong>内容，
  包含了<em>重要信息</em>。
</div>
```

**当前提取结果：**
- ✅ "这是产品介绍的"
- ✅ "第一段"
- ✅ "内容， 包含了"
- ✅ "重要信息"

**问题：**
- ❌ 文本被拆分成 4 个片段，翻译时无法保持 HTML 结构
- ❌ 应该提取: "这是产品介绍的**第一段**内容，包含了*重要信息*。" 或标记为需要人工处理

---

### 问题6: 带标点的分散文本

**场景：**
```vue
<div>
  <span>提示</span>
  <span>：</span>
  <span>请仔细阅读</span>
</div>
```

**当前提取结果：**
- ✅ "提示"
- ❌ "：" (应该被排除，纯标点)
- ✅ "请仔细阅读"

**问题：**
- ❌ 拆分成多个片段
- ❌ 应该提取: "提示：请仔细阅读"

---

## 🎯 问题分类

### A 类：需要合并的文本（高优先级）

**特征**：同一父元素下的多个文本节点应该合并

1. **纯文本分散**
   ```vue
   <div><span>总共</span><span>条记录</span></div>
   ```
   → 应提取: "总共_条记录" 或标记关联关系

2. **文本+插值+文本**
   ```vue
   <div>当前页：{{ page }} / 总页数：{{ total }}</div>
   ```
   → 应提取: "当前页：{page} / 总页数：{total}"

3. **带标点的分散文本**
   ```vue
   <div><span>提示</span><span>：</span><span>内容</span></div>
   ```
   → 应提取: "提示：内容"

### B 类：需要标记的场景（中优先级）

**特征**：包含 HTML 标签的长文本，需要人工审核

```vue
<div>这是<strong>重要</strong>的内容。</div>
```
→ 标记为 "包含 HTML"，建议人工处理

### C 类：可以忽略的文本（低优先级）

**特征**：纯标点、空格、数字

```vue
<span>：</span>
<span> / </span>
<span>123</span>
```
→ 应该被排除

---

## 💡 解决方案建议

### 方案1: 同级文本合并（推荐）

**实现思路**：
1. 遍历时，收集同一父元素下的所有子节点
2. 如果包含多个文本节点，尝试合并
3. 插值表达式用 `{name}` 占位
4. 保存原始结构供人工审核

**示例：**
```typescript
// 输入
<div>
  <span>已选择</span>
  <span>{{ count }}</span>
  <span>项</span>
</div>

// 输出
{
  text: "已选择{count}项",
  originalStructure: [...], // 保存原始 AST
  needsReview: false, // 简单合并无需审核
}
```

### 方案2: 包含 HTML 的文本标记

**实现思路**：
1. 检测文本节点是否有兄弟元素节点
2. 如果有，标记为 "包含 HTML"
3. 提供原始 HTML 结构

**示例：**
```typescript
// 输入
<div>这是<strong>重要</strong>内容</div>

// 输出
{
  text: "这是 重要 内容", // 简化版
  htmlStructure: "这是<strong>重要</strong>内容",
  needsReview: true,
  tags: ['包含HTML标签']
}
```

### 方案3: 纯标点过滤增强

**实现思路**：
在 `shouldExclude` 函数中增加标点检测

```typescript
// 纯标点、空格、数字
if (/^[\s\d\p{P}]+$/u.test(text)) {
  return true; // 排除
}
```

---

## 📋 补充的边界场景

### 场景7: v-for 循环中的文本

```vue
<div v-for="item in items" :key="item.id">
  <span>项目名称：</span>
  <span>{{ item.name }}</span>
</div>
```

**问题**: 循环中的文本如何处理？

### 场景8: v-if/v-else 条件文本

```vue
<div v-if="type === 'success'">操作成功</div>
<div v-else>操作失败</div>
```

**问题**: 条件文本的关联关系？

### 场景9: 插槽文本

```vue
<slot>默认文本</slot>
```

**问题**: 插槽默认值是否提取？

### 场景10: 注释中的中文

```vue
<!-- 这是注释 -->
<div>内容</div>
```

**问题**: 注释是否应该忽略？（当前已忽略 ✅）

---

## 🎯 总结

### 当前能处理（✅）
1. ✅ 独立的完整文本节点
2. ✅ 静态属性文本
3. ✅ 列表项、表格单元格
4. ✅ 按钮、链接文本

### 需要改进（⚠️）
1. ⚠️ 同级多个文本节点应该合并
2. ⚠️ 包含插值的文本应该参数化
3. ⚠️ 包含 HTML 标签的文本应该标记
4. ⚠️ 纯标点应该被排除
5. ⚠️ 提供更丰富的上下文信息

### 建议实现顺序
1. **优先**: 同级文本合并 + 插值参数化
2. **次要**: HTML 标签标记
3. **可选**: 条件文本、循环文本的关联

